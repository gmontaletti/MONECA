<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>MONECA Package Revision Plan • moneca</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Roboto-0.4.10/font.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="MONECA Package Revision Plan"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">moneca</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/moneca-introduction.html">Introduction to moneca: Mobility Network Clustering Analysis</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news"><li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="dropdown-item" href="https://gmontaletti.github.io/MONECA/news/index.html#moneca-100">Version 1.0.0</a></li>
    <li><a class="dropdown-item" href="https://gmontaletti.github.io/MONECA/news/index.html#moneca-09">Version 0.9</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="news/index.html">Changelog</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gmontaletti/MONECA/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>MONECA Package Revision Plan</h1>
      <small class="dont-index">Source: <a href="https://github.com/gmontaletti/MONECA/blob/master/REVISION_PLAN.md" class="external-link"><code>REVISION_PLAN.md</code></a></small>
    </div>

<div id="moneca-package-revision-plan" class="section level1">

<p><strong>Author</strong>: Giampaolo Montaletti <strong>Date</strong>: 2025-11-25 <strong>Version</strong>: 0.9.2 → 1.0.0</p>
<hr><div class="section level2">
<h2 id="executive-summary">Executive Summary<a class="anchor" aria-label="anchor" href="#executive-summary"></a></h2>
<p>This plan outlines a comprehensive revision of the moneca package to: 1. Streamline the API to a coherent core focused on clustering and segment membership 2. Optimize performance through vectorization and data.table 3. Restructure unit tests for maintainability 4. Consolidate documentation</p>
<hr></div>
<div class="section level2">
<h2 id="phase-1-api-consolidation-export-reduction">Phase 1: API Consolidation (Export Reduction)<a class="anchor" aria-label="anchor" href="#phase-1-api-consolidation-export-reduction"></a></h2>
<div class="section level3">
<h3 id="current-state">Current State<a class="anchor" aria-label="anchor" href="#current-state"></a></h3>
<ul><li>
<strong>72 exported functions</strong> + 17 S3 methods</li>
<li>Functions span: clustering, tuning, plotting, diagnostics, temporal analysis, utilities</li>
</ul></div>
<div class="section level3">
<h3 id="target-state">Target State<a class="anchor" aria-label="anchor" href="#target-state"></a></h3>
<p>Reduce to <strong>~20 core exports</strong> organized into coherent functional groups.</p>
</div>
<div class="section level3">
<h3 id="proposed-core-api">Proposed Core API<a class="anchor" aria-label="anchor" href="#proposed-core-api"></a></h3>
<div class="section level4">
<h4 id="tier-1-essential-clustering-8-functions">Tier 1: Essential Clustering (8 functions)<a class="anchor" aria-label="anchor" href="#tier-1-essential-clustering-8-functions"></a></h4>
<table class="table"><colgroup><col width="37%"><col width="33%"><col width="29%"></colgroup><thead><tr class="header"><th>Function</th>
<th>Purpose</th>
<th>Status</th>
</tr></thead><tbody><tr class="odd"><td><code><a href="reference/moneca.html">moneca()</a></code></td>
<td>Original clustering algorithm</td>
<td>KEEP (unchanged per CLAUDE.md)</td>
</tr><tr class="even"><td><code><a href="reference/moneca_fast.html">moneca_fast()</a></code></td>
<td>Optimized single-core implementation</td>
<td>KEEP (optimize further)</td>
</tr><tr class="odd"><td><code><a href="reference/weight.matrix.html">weight.matrix()</a></code></td>
<td>Create relative risk matrix</td>
<td>KEEP</td>
</tr><tr class="even"><td><code><a href="reference/segment.membership.html">segment.membership()</a></code></td>
<td>Extract segment assignments</td>
<td>KEEP</td>
</tr><tr class="odd"><td><code><a href="reference/segment.membership.dataframe.html">segment.membership.dataframe()</a></code></td>
<td>Segments as tidy dataframe</td>
<td>KEEP</td>
</tr><tr class="even"><td><code><a href="reference/segment.quality.html">segment.quality()</a></code></td>
<td>Quality metrics</td>
<td>KEEP</td>
</tr><tr class="odd"><td><code><a href="reference/segment.edges.html">segment.edges()</a></code></td>
<td>Extract weighted edges</td>
<td>KEEP</td>
</tr><tr class="even"><td><code><a href="reference/generate_mobility_data.html">generate_mobility_data()</a></code></td>
<td>Synthetic data generation</td>
<td>KEEP</td>
</tr></tbody></table></div>
<div class="section level4">
<h4 id="tier-2-visualization-5-functions">Tier 2: Visualization (5 functions)<a class="anchor" aria-label="anchor" href="#tier-2-visualization-5-functions"></a></h4>
<table class="table"><thead><tr class="header"><th>Function</th>
<th>Purpose</th>
<th>Status</th>
</tr></thead><tbody><tr class="odd"><td><code><a href="reference/plot_moneca_ggraph.html">plot_moneca_ggraph()</a></code></td>
<td>Modern network visualization</td>
<td>KEEP</td>
</tr><tr class="even"><td><code><a href="reference/plot_ego_ggraph.html">plot_ego_ggraph()</a></code></td>
<td>Ego network visualization</td>
<td>KEEP</td>
</tr><tr class="odd"><td><code><a href="reference/plot_stair_ggraph.html">plot_stair_ggraph()</a></code></td>
<td>Multi-level visualization</td>
<td>KEEP</td>
</tr><tr class="even"><td><code><a href="reference/plot_moneca_dendrogram.html">plot_moneca_dendrogram()</a></code></td>
<td>Hierarchical dendrogram</td>
<td>KEEP</td>
</tr><tr class="odd"><td><code><a href="reference/plot_segment_quality.html">plot_segment_quality()</a></code></td>
<td>Quality visualization</td>
<td>KEEP</td>
</tr></tbody></table></div>
<div class="section level4">
<h4 id="tier-3-tuning-4-functions">Tier 3: Tuning (4 functions)<a class="anchor" aria-label="anchor" href="#tier-3-tuning-4-functions"></a></h4>
<table class="table"><thead><tr class="header"><th>Function</th>
<th>Purpose</th>
<th>Status</th>
</tr></thead><tbody><tr class="odd"><td><code><a href="reference/auto_tune_small_cell_reduction.html">auto_tune_small_cell_reduction()</a></code></td>
<td>Main parameter tuning</td>
<td>KEEP</td>
</tr><tr class="even"><td><code>find_optimal_cutoff()</code></td>
<td>Optimal cutoff determination</td>
<td>KEEP</td>
</tr><tr class="odd"><td><code>analyze_rr_distribution()</code></td>
<td>Relative risk analysis</td>
<td>KEEP</td>
</tr><tr class="even"><td><code>plot_tuning_results()</code></td>
<td>Tuning visualization</td>
<td>KEEP</td>
</tr></tbody></table></div>
<div class="section level4">
<h4 id="tier-4-utilities-3-functions">Tier 4: Utilities (3 functions)<a class="anchor" aria-label="anchor" href="#tier-4-utilities-3-functions"></a></h4>
<table class="table"><thead><tr class="header"><th>Function</th>
<th>Purpose</th>
<th>Status</th>
</tr></thead><tbody><tr class="odd"><td><code><a href="reference/segment.colors.html">segment.colors()</a></code></td>
<td>Color generation for segments</td>
<td>KEEP</td>
</tr><tr class="even"><td><code><a href="reference/layout.matrix.html">layout.matrix()</a></code></td>
<td>Layout computation</td>
<td>KEEP</td>
</tr><tr class="odd"><td><code><a href="reference/vertex.mobility.html">vertex.mobility()</a></code></td>
<td>Node mobility metrics</td>
<td>KEEP</td>
</tr></tbody></table></div>
</div>
<div class="section level3">
<h3 id="functions-to-move-to-internal-not-exported">Functions to Move to Internal (Not Exported)<a class="anchor" aria-label="anchor" href="#functions-to-move-to-internal-not-exported"></a></h3>
<div class="section level4">
<h4 id="move-to-internal-35-functions">Move to Internal (~35 functions)<a class="anchor" aria-label="anchor" href="#move-to-internal-35-functions"></a></h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Low-level algorithms (internal implementation details)</span></span>
<span><span class="fu"><a href="reference/find.segments.html">find.segments</a></span><span class="op">(</span><span class="op">)</span>              <span class="co"># Used internally by moneca/moneca_fast</span></span>
<span><span class="fu">find.segments.parallel</span><span class="op">(</span><span class="op">)</span>     <span class="co"># Internal parallel implementation</span></span>
<span><span class="fu"><a href="reference/force.segments.html">force.segments</a></span><span class="op">(</span><span class="op">)</span>             <span class="co"># Internal forcing mechanism</span></span>
<span><span class="fu">segment.matrix.parallel</span><span class="op">(</span><span class="op">)</span>    <span class="co"># Internal aggregation</span></span>
<span><span class="fu">weight.matrix.parallel</span><span class="op">(</span><span class="op">)</span>     <span class="co"># Internal parallel computation</span></span>
<span></span>
<span><span class="co"># Diagnostic utilities (developer-focused)</span></span>
<span><span class="fu">test_igraph_compatibility</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">analyze_package_dependencies</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">validate_description_dependencies</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">generate_dependency_report</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">diagnose_parallel_execution</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">monitor_system_resources</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">benchmark_parallel_performance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">detect_system_resources</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">get_optimal_cores</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">should_use_parallel</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">clear_evaluation_caches</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">get_cache_stats</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Advanced tuning (niche use cases)</span></span>
<span><span class="fu">auto_tune_small_cell_reduction_enhanced</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">auto_tune_joint_parameters</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/assess_clustering_stability.html">assess_clustering_stability</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/assess_clustering_stability_parallel.html">assess_clustering_stability_parallel</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/compute_tuning_metrics.html">compute_tuning_metrics</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/compute_clustering_quality_metrics.html">compute_clustering_quality_metrics</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/generate_candidate_values.html">generate_candidate_values</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">analyze_parameter_interaction</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_optimization_surface</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">suggest_parameter_ranges</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/evaluate_performance_trade_offs.html">evaluate_performance_trade_offs</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cutoff_sensitivity_analysis</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">evaluate_cutoff_strength</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">calculate_strength_density</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">parameter_sensitivity_plot</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">performance_quality_tradeoff_plot</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_cutoff_analysis</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_cutoff_interactive</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_rr_distribution</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_strength_comparison</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_elbow_curve</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="functions-to-deprecateremove-15-functions">Functions to Deprecate/Remove (~15 functions)<a class="anchor" aria-label="anchor" href="#functions-to-deprecateremove-15-functions"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallel variants (consolidate into main functions with parallel argument)</span></span>
<span><span class="fu">moneca_parallel</span><span class="op">(</span><span class="op">)</span>         <span class="co"># Merge into moneca_fast(parallel = TRUE)</span></span>
<span></span>
<span><span class="co"># Temporal analysis (spin off to separate package or vignette-only)</span></span>
<span><span class="fu">moneca_temporal</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">temporal_stability_analysis</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">export_node_trajectories</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_temporal_segments</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_temporal_stability</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">generate_temporal_report</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Maximal cliques variant (experimental)</span></span>
<span><span class="fu"><a href="reference/new_moneca.html">new_moneca</a></span><span class="op">(</span><span class="op">)</span>              <span class="co"># Document as experimental internal</span></span>
<span></span>
<span><span class="co"># Legacy plotting (superseded by ggraph versions)</span></span>
<span><span class="fu"><a href="reference/gg.moneca.html">gg.moneca</a></span><span class="op">(</span><span class="op">)</span>               <span class="co"># Soft deprecate, keep working</span></span>
<span><span class="fu"><a href="reference/ego.plot.html">ego.plot</a></span><span class="op">(</span><span class="op">)</span>                <span class="co"># Soft deprecate</span></span>
<span><span class="fu"><a href="reference/stair.plot.html">stair.plot</a></span><span class="op">(</span><span class="op">)</span>              <span class="co"># Soft deprecate</span></span>
<span><span class="fu"><a href="reference/moneca.plot.html">moneca.plot</a></span><span class="op">(</span><span class="op">)</span>             <span class="co"># Soft deprecate</span></span>
<span></span>
<span><span class="co"># Redundant membership functions</span></span>
<span><span class="fu"><a href="reference/segment.membership.enhanced.html">segment.membership.enhanced</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Merge into segment.membership()</span></span>
<span><span class="fu"><a href="reference/first.level.summary.html">first.level.summary</a></span><span class="op">(</span><span class="op">)</span>          <span class="co"># Integrate into print.moneca()</span></span>
<span></span>
<span><span class="co"># Example dataset generator (too specific)</span></span>
<span><span class="fu"><a href="reference/generate_example_datasets.html">generate_example_datasets</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># Keep generate_mobility_data() only</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="implementation-steps">Implementation Steps<a class="anchor" aria-label="anchor" href="#implementation-steps"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Create internal function wrappers</strong>
<ul><li>Move functions to internal namespace</li>
<li>Add <code>@keywords internal</code> roxygen tags</li>
<li>Update calling code</li>
</ul></li>
<li>
<strong>Soft deprecation for legacy functions</strong>
<ul><li>Add <code><a href="https://rdrr.io/r/base/Deprecated.html" class="external-link">.Deprecated()</a></code> calls with migration guidance</li>
<li>Keep working for 2 versions</li>
</ul></li>
<li>
<strong>Merge redundant functions</strong>
<ul><li>
<code><a href="reference/segment.membership.enhanced.html">segment.membership.enhanced()</a></code> → options in <code><a href="reference/segment.membership.html">segment.membership()</a></code>
</li>
<li>
<code>moneca_parallel()</code> → <code>moneca_fast(parallel = TRUE)</code>
</li>
</ul></li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="phase-2-performance-optimization">Phase 2: Performance Optimization<a class="anchor" aria-label="anchor" href="#phase-2-performance-optimization"></a></h2>
<div class="section level3">
<h3 id="critical-bottlenecks-identified">Critical Bottlenecks Identified<a class="anchor" aria-label="anchor" href="#critical-bottlenecks-identified"></a></h3>
<div class="section level4">
<h4 id="bottleneck-1-findsegments-main-loop">Bottleneck 1: <code>find.segments()</code> Main Loop<a class="anchor" aria-label="anchor" href="#bottleneck-1-findsegments-main-loop"></a></h4>
<p><strong>Location</strong>: <code>R/analytical_functions.R:94-136</code> <strong>Complexity</strong>: O(n²) where n = edges above cutoff <strong>Current Implementation</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">loop.length</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">max.ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">max.mat</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">max.mat</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, arr.ind<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span>    <span class="co"># ... sequential processing</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Optimization Strategy</strong>: 1. Pre-compute all edge values and sort once 2. Use vectorized clique membership testing 3. Leverage data.table for fast lookups</p>
</div>
<div class="section level4">
<h4 id="bottleneck-2-cliquetest-inner-function">Bottleneck 2: <code>clique.test()</code> Inner Function<a class="anchor" aria-label="anchor" href="#bottleneck-2-cliquetest-inner-function"></a></h4>
<p><strong>Location</strong>: <code>R/analytical_functions.R:65-75</code> <strong>Complexity</strong>: O(k) per call where k = number of cliques <strong>Current Implementation</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cliques</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">potential.clique</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cl</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Optimization Strategy</strong>: 1. Pre-build clique membership matrix (already in moneca_fast) 2. Use matrix operations for subset testing 3. Implement early termination with sorted cliques</p>
</div>
<div class="section level4">
<h4 id="bottleneck-3-edge-processing-loop">Bottleneck 3: Edge Processing Loop<a class="anchor" aria-label="anchor" href="#bottleneck-3-edge-processing-loop"></a></h4>
<p><strong>Location</strong>: <code>R/moneca_fast.R:211-237</code> <strong>Issue</strong>: Sequential dependency in segment assignment</p>
<p><strong>Optimization Strategy</strong>: 1. Batch process independent edges 2. Use data.table for fast grouping operations 3. Implement incremental segment updates</p>
</div>
</div>
<div class="section level3">
<h3 id="proposed-optimized-implementation">Proposed Optimized Implementation<a class="anchor" aria-label="anchor" href="#proposed-optimized-implementation"></a></h3>
<div class="section level4">
<h4 id="new-function-find_segments_optimized">New Function: <code>find_segments_optimized()</code>
<a class="anchor" aria-label="anchor" href="#new-function-find_segments_optimized"></a></h4>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @title Optimized Segment Finding</span></span>
<span><span class="co">#' @description Vectorized segment identification using data.table</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="va">find_segments_optimized</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">cutoff.rr</span>, <span class="va">cliques</span>, <span class="va">verbose</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># 1. Pre-compute: Convert to data.table of edges</span></span>
<span>  <span class="va">edges_dt</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu">as.data.table</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">mat</span> <span class="op">&gt;</span> <span class="va">cutoff.rr</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">edges_dt</span><span class="op">[</span>, <span class="va">weight</span> <span class="op">:=</span> <span class="va">mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">row</span>, <span class="va">col</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">edges_dt</span><span class="op">[</span>, <span class="va">edge_id</span> <span class="op">:=</span> <span class="va">.I</span><span class="op">]</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu">setkey</span><span class="op">(</span><span class="va">edges_dt</span>, <span class="va">weight</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 2. Pre-build clique membership lookup</span></span>
<span>  <span class="va">n_nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span></span>
<span>  <span class="va">clique_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">FALSE</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cliques</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">n_nodes</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">cliques</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">clique_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">cliques</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># 3. Vectorized clique membership test function</span></span>
<span>  <span class="va">test_in_clique</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">node_pairs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Returns logical vector: TRUE if pair is in any clique</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">node_pairs</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pair</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">clique_matrix</span><span class="op">[</span>, <span class="va">pair</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">clique_matrix</span><span class="op">[</span>, <span class="va">pair</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># 4. Sort edges by weight (descending) - single sort operation</span></span>
<span>  <span class="va">edges_dt</span> <span class="op">&lt;-</span> <span class="va">edges_dt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">weight</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># 5. Process edges in batches where possible</span></span>
<span>  <span class="va">segments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="va">n_nodes</span><span class="op">)</span></span>
<span>  <span class="va">current_segment</span> <span class="op">&lt;-</span> <span class="fl">0L</span></span>
<span></span>
<span>  <span class="co"># Group processing with data.table</span></span>
<span>  <span class="va">edges_dt</span><span class="op">[</span>, <span class="va">in_clique</span> <span class="op">:=</span> <span class="fu">test_in_clique</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">row</span>, <span class="va">col</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Sequential assignment (necessary for correctness)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">edges_dt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">edges_dt</span><span class="op">$</span><span class="va">in_clique</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="kw">next</span></span>
<span></span>
<span>    <span class="va">row_i</span> <span class="op">&lt;-</span> <span class="va">edges_dt</span><span class="op">$</span><span class="va">row</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">col_i</span> <span class="op">&lt;-</span> <span class="va">edges_dt</span><span class="op">$</span><span class="va">col</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">seg_row</span> <span class="op">&lt;-</span> <span class="va">segments</span><span class="op">[</span><span class="va">row_i</span><span class="op">]</span></span>
<span>    <span class="va">seg_col</span> <span class="op">&lt;-</span> <span class="va">segments</span><span class="op">[</span><span class="va">col_i</span><span class="op">]</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">seg_row</span> <span class="op">==</span> <span class="fl">0L</span> <span class="op">&amp;&amp;</span> <span class="va">seg_col</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">current_segment</span> <span class="op">&lt;-</span> <span class="va">current_segment</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span>      <span class="va">segments</span><span class="op">[</span><span class="va">row_i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">current_segment</span></span>
<span>      <span class="va">segments</span><span class="op">[</span><span class="va">col_i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">current_segment</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">seg_row</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">segments</span><span class="op">[</span><span class="va">row_i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">seg_col</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">seg_col</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">segments</span><span class="op">[</span><span class="va">col_i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">seg_row</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># Both already assigned - skip (segment merge handled later)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># 6. Assign singletons</span></span>
<span>  <span class="va">singletons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">segments</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">singletons</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">current_segment</span> <span class="op">&lt;-</span> <span class="va">current_segment</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span>    <span class="va">segments</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">current_segment</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">segments</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="linear-algebra-optimization-weight-matrix">Linear Algebra Optimization: Weight Matrix<a class="anchor" aria-label="anchor" href="#linear-algebra-optimization-weight-matrix"></a></h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @title Optimized Weight Matrix Computation</span></span>
<span><span class="co">#' @description Vectorized relative risk calculation</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="va">weight_matrix_optimized</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">cutoff.rr</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">small.cell.reduction</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Vectorized row/column totals</span></span>
<span>  <span class="va">row_totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">mat</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">col_totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">mat</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">grand_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mat</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Expected values (outer product for vectorization)</span></span>
<span>  <span class="va">expected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">row_totals</span>, <span class="va">col_totals</span><span class="op">)</span> <span class="op">/</span> <span class="va">grand_total</span></span>
<span></span>
<span>  <span class="co"># Small cell adjustment (vectorized)</span></span>
<span>  <span class="va">mat_adj</span> <span class="op">&lt;-</span> <span class="va">mat</span></span>
<span>  <span class="va">mat_adj</span><span class="op">[</span><span class="va">mat</span> <span class="op">&lt;</span> <span class="va">small.cell.reduction</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">small.cell.reduction</span></span>
<span>  <span class="va">expected</span><span class="op">[</span><span class="va">expected</span> <span class="op">&lt;</span> <span class="va">small.cell.reduction</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">small.cell.reduction</span></span>
<span></span>
<span>  <span class="co"># Relative risk (element-wise)</span></span>
<span>  <span class="va">rr</span> <span class="op">&lt;-</span> <span class="va">mat_adj</span> <span class="op">/</span> <span class="va">expected</span></span>
<span></span>
<span>  <span class="co"># Apply cutoff (vectorized)</span></span>
<span>  <span class="va">rr</span><span class="op">[</span><span class="va">rr</span> <span class="op">&lt;</span> <span class="va">cutoff.rr</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">rr</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="performance-testing-requirements">Performance Testing Requirements<a class="anchor" aria-label="anchor" href="#performance-testing-requirements"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Benchmark Suite</strong>
<ul><li>Create standardized test matrices (100x100, 500x500, 1000x1000)</li>
<li>Measure time and memory for each implementation</li>
<li>Verify result equivalence with <code><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal()</a></code>
</li>
</ul></li>
<li>
<strong>Regression Tests</strong>
<ul><li>All existing test cases must pass with identical results</li>
<li>Add explicit numerical tolerance tests</li>
</ul></li>
<li>
<strong>Expected Improvements</strong>
<ul><li>Target: 5-10x speedup for large matrices (&gt;500 categories)</li>
<li>Memory: Reduce peak memory by avoiding intermediate copies</li>
</ul></li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="phase-3-unit-test-restructuring">Phase 3: Unit Test Restructuring<a class="anchor" aria-label="anchor" href="#phase-3-unit-test-restructuring"></a></h2>
<div class="section level3">
<h3 id="current-state-1">Current State<a class="anchor" aria-label="anchor" href="#current-state-1"></a></h3>
<ul><li>
<strong>20 test files</strong> with significant overlap</li>
<li>Total ~170,000 lines of test code</li>
<li>Some files &gt;10,000 lines (test-auto-tuning.R: 20,900 lines)</li>
</ul></div>
<div class="section level3">
<h3 id="problems-identified">Problems Identified<a class="anchor" aria-label="anchor" href="#problems-identified"></a></h3>
<ol style="list-style-type: decimal"><li>Test files too large and monolithic</li>
<li>Duplicate test logic across files</li>
<li>No clear test hierarchy (unit vs integration)</li>
<li>Performance tests mixed with correctness tests</li>
</ol></div>
<div class="section level3">
<h3 id="proposed-test-structure">Proposed Test Structure<a class="anchor" aria-label="anchor" href="#proposed-test-structure"></a></h3>
<pre><code>tests/
├── testthat/
│   ├── unit/
│   │   ├── test-weight-matrix.R          # weight.matrix() unit tests
│   │   ├── test-find-segments.R          # find.segments() unit tests
│   │   ├── test-segment-membership.R     # membership extraction tests
│   │   ├── test-segment-quality.R        # quality metrics tests
│   │   ├── test-synthetic-data.R         # data generation tests
│   │   └── test-igraph-compat.R          # compatibility layer tests
│   │
│   ├── integration/
│   │   ├── test-moneca-pipeline.R        # Full clustering pipeline
│   │   ├── test-moneca-fast-equiv.R      # moneca vs moneca_fast equivalence
│   │   ├── test-visualization.R          # Plotting integration tests
│   │   └── test-tuning-workflow.R        # Auto-tuning workflow
│   │
│   ├── performance/
│   │   ├── test-benchmark-clustering.R   # Clustering benchmarks
│   │   ├── test-benchmark-optimization.R # Optimization validation
│   │   └── test-memory-usage.R           # Memory profiling tests
│   │
│   ├── regression/
│   │   ├── test-known-results.R          # Fixed input/output tests
│   │   ├── test-edge-cases.R             # Boundary conditions
│   │   └── test-infinite-loop.R          # Regression for fixed bugs
│   │
│   └── helpers/
│       ├── helper-test-data.R            # Shared test data generators
│       ├── helper-assertions.R           # Custom test assertions
│       └── helper-fixtures.R             # Test fixtures
│
└── testthat.R</code></pre>
</div>
<div class="section level3">
<h3 id="test-consolidation-plan">Test Consolidation Plan<a class="anchor" aria-label="anchor" href="#test-consolidation-plan"></a></h3>
<table class="table"><colgroup><col width="34%"><col width="43%"><col width="21%"></colgroup><thead><tr class="header"><th>Old Files</th>
<th>New Location</th>
<th>Notes</th>
</tr></thead><tbody><tr class="odd"><td>test-moneca-core.R</td>
<td>unit/test-weight-matrix.R, unit/test-find-segments.R</td>
<td>Split by function</td>
</tr><tr class="even"><td>test-moneca-fast.R</td>
<td>integration/test-moneca-fast-equiv.R</td>
<td>Focus on equivalence</td>
</tr><tr class="odd"><td>test-algorithm-equivalence.R</td>
<td>integration/test-moneca-fast-equiv.R</td>
<td>Merge</td>
</tr><tr class="even"><td>test-plotting.R</td>
<td>integration/test-visualization.R</td>
<td>Keep focused</td>
</tr><tr class="odd"><td>test-synthetic-data.R</td>
<td>unit/test-synthetic-data.R</td>
<td>Keep</td>
</tr><tr class="even"><td>test-igraph-compatibility.R</td>
<td>unit/test-igraph-compat.R</td>
<td>Keep</td>
</tr><tr class="odd"><td>test-auto-tuning*.R (4 files)</td>
<td>integration/test-tuning-workflow.R</td>
<td>Consolidate</td>
</tr><tr class="even"><td>test-cutoff-strength.R</td>
<td>unit/test-segment-quality.R</td>
<td>Integrate</td>
</tr><tr class="odd"><td>test-parallel-*.R (3 files)</td>
<td>Remove or minimal</td>
<td>Parallel is internal</td>
</tr><tr class="even"><td>test-temporal-*.R (3 files)</td>
<td>Remove</td>
<td>Temporal is deprecated</td>
</tr><tr class="odd"><td>test-infinite-loop-regression.R</td>
<td>regression/test-infinite-loop.R</td>
<td>Keep</td>
</tr><tr class="even"><td>test-new-moneca.R</td>
<td>Remove or internal</td>
<td>new_moneca is internal</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="test-helper-functions">Test Helper Functions<a class="anchor" aria-label="anchor" href="#test-helper-functions"></a></h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># helper-test-data.R</span></span>
<span></span>
<span><span class="co">#' Generate standard test matrices</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="va">generate_test_matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">size</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"small"</span>, <span class="st">"medium"</span>, <span class="st">"large"</span><span class="op">)</span>,</span>
<span>                                  <span class="va">type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simple"</span>, <span class="st">"complex"</span>, <span class="st">"sparse"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">size</span><span class="op">)</span></span>
<span>  <span class="va">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">size</span>,</span>
<span>    small <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    medium <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    large <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">seed</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">type</span>,</span>
<span>    simple <span class="op">=</span> <span class="fl">123</span>,</span>
<span>    complex <span class="op">=</span> <span class="fl">456</span>,</span>
<span>    sparse <span class="op">=</span> <span class="fl">789</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="reference/generate_mobility_data.html">generate_mobility_data</a></span><span class="op">(</span>n_classes <span class="op">=</span> <span class="va">n</span>, seed <span class="op">=</span> <span class="va">seed</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Assert moneca results equivalence</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="va">expect_moneca_equal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">result1</span>, <span class="va">result2</span>, <span class="va">tolerance</span> <span class="op">=</span> <span class="fl">1e-10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span></span>
<span>    <span class="va">result1</span><span class="op">$</span><span class="va">segment.list</span>,</span>
<span>    <span class="va">result2</span><span class="op">$</span><span class="va">segment.list</span>,</span>
<span>    tolerance <span class="op">=</span> <span class="va">tolerance</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">result1</span><span class="op">$</span><span class="va">mat.list</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">result2</span><span class="op">$</span><span class="va">mat.list</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="coverage-targets">Coverage Targets<a class="anchor" aria-label="anchor" href="#coverage-targets"></a></h3>
<table class="table"><thead><tr class="header"><th>Category</th>
<th>Target</th>
<th>Measurement</th>
</tr></thead><tbody><tr class="odd"><td>Core functions</td>
<td>95%</td>
<td>Line coverage</td>
</tr><tr class="even"><td>Visualization</td>
<td>80%</td>
<td>Branch coverage</td>
</tr><tr class="odd"><td>Tuning</td>
<td>85%</td>
<td>Line coverage</td>
</tr><tr class="even"><td>Overall</td>
<td>90%</td>
<td>Line coverage</td>
</tr></tbody></table><hr></div>
</div>
<div class="section level2">
<h2 id="phase-4-documentation-rework">Phase 4: Documentation Rework<a class="anchor" aria-label="anchor" href="#phase-4-documentation-rework"></a></h2>
<div class="section level3">
<h3 id="current-state-2">Current State<a class="anchor" aria-label="anchor" href="#current-state-2"></a></h3>
<ul><li>5 vignettes (some overlap)</li>
<li>README.md with installation and quick start</li>
<li>Roxygen2 documentation for all exported functions</li>
</ul></div>
<div class="section level3">
<h3 id="problems">Problems<a class="anchor" aria-label="anchor" href="#problems"></a></h3>
<ol style="list-style-type: decimal"><li>Too many vignettes for a focused package</li>
<li>Documentation spread across files</li>
<li>Some examples use deprecated patterns</li>
</ol></div>
<div class="section level3">
<h3 id="proposed-documentation-structure">Proposed Documentation Structure<a class="anchor" aria-label="anchor" href="#proposed-documentation-structure"></a></h3>
<div class="section level4">
<h4 id="vignettes-consolidate-to-2">Vignettes (Consolidate to 2)<a class="anchor" aria-label="anchor" href="#vignettes-consolidate-to-2"></a></h4>
<ol style="list-style-type: decimal"><li>
<strong>moneca-introduction.Rmd</strong> (KEEP, REVISE)
<ul><li>Package overview</li>
<li>Installation</li>
<li>Basic workflow</li>
<li>Interpreting results</li>
<li>Visualization options</li>
</ul></li>
<li>
<strong>moneca-advanced.Rmd</strong> (NEW, from merging)
<ul><li>Parameter tuning</li>
<li>Performance optimization</li>
<li>Working with large matrices</li>
<li>Custom visualization</li>
</ul></li>
</ol></div>
<div class="section level4">
<h4 id="removearchive">Remove/Archive<a class="anchor" aria-label="anchor" href="#removearchive"></a></h4>
<ul><li>algorithm-comparison.Rmd → Archive to reference/</li>
<li>moneca-statistics.Rmd → Integrate into introduction</li>
<li>auto-tuning-guide.Rmd → Merge into advanced</li>
<li>parameter-calibration.Rmd → Merge into advanced</li>
</ul></div>
</div>
<div class="section level3">
<h3 id="function-documentation-updates">Function Documentation Updates<a class="anchor" aria-label="anchor" href="#function-documentation-updates"></a></h3>
<div class="section level4">
<h4 id="priority-1-core-functions-full-rewrite">Priority 1: Core Functions (Full Rewrite)<a class="anchor" aria-label="anchor" href="#priority-1-core-functions-full-rewrite"></a></h4>
<ul><li>
<code><a href="reference/moneca.html">moneca()</a></code> - Complete examples, parameter explanations</li>
<li>
<code><a href="reference/moneca_fast.html">moneca_fast()</a></code> - Performance comparison, when to use</li>
<li>
<code><a href="reference/weight.matrix.html">weight.matrix()</a></code> - Mathematical explanation</li>
<li>
<code><a href="reference/segment.membership.html">segment.membership()</a></code> - All output formats</li>
<li>
<code><a href="reference/plot_moneca_ggraph.html">plot_moneca_ggraph()</a></code> - Comprehensive visualization guide</li>
</ul></div>
<div class="section level4">
<h4 id="priority-2-update-examples">Priority 2: Update Examples<a class="anchor" aria-label="anchor" href="#priority-2-update-examples"></a></h4>
<ul><li>Replace legacy data with <code><a href="reference/generate_mobility_data.html">generate_mobility_data()</a></code>
</li>
<li>Show modern ggraph plotting in all examples</li>
<li>Add practical use cases</li>
</ul></div>
<div class="section level4">
<h4 id="priority-3-cross-references">Priority 3: Cross-references<a class="anchor" aria-label="anchor" href="#priority-3-cross-references"></a></h4>
<ul><li>Add <code>@seealso</code> to all related functions</li>
<li>Link to vignettes from function docs</li>
<li>Add <code>@family</code> tags for grouping</li>
</ul></div>
</div>
<div class="section level3">
<h3 id="readmemd-updates">README.md Updates<a class="anchor" aria-label="anchor" href="#readmemd-updates"></a></h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu"># moneca</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>Mobility Network Clustering Analysis - Create weighted networks from</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>mobility tables and use cliques to create discrete and nested clusters.</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="fu">## Installation</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co"># Install from GitHub</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"gmontaletti/moneca"</span>)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="quick-start">Quick Start<a class="anchor" aria-label="anchor" href="#quick-start"></a></h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gmontaletti.github.io/MONECA/">moneca</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate example data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/generate_mobility_data.html">generate_mobility_data</a></span><span class="op">(</span>n_classes <span class="op">=</span> <span class="fl">10</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run clustering</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/moneca_fast.html">moneca_fast</a></span><span class="op">(</span><span class="va">data</span>, segment.levels <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get segment memberships</span></span>
<span><span class="va">segments</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/segment.membership.html">segment.membership</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize</span></span>
<span><span class="fu"><a href="reference/plot_moneca_ggraph.html">plot_moneca_ggraph</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="core-functions">Core Functions<a class="anchor" aria-label="anchor" href="#core-functions"></a></h2>
<table class="table"><thead><tr class="header"><th>Function</th>
<th>Purpose</th>
</tr></thead><tbody><tr class="odd"><td><code><a href="reference/moneca_fast.html">moneca_fast()</a></code></td>
<td>Fast hierarchical clustering</td>
</tr><tr class="even"><td><code><a href="reference/segment.membership.html">segment.membership()</a></code></td>
<td>Extract cluster assignments</td>
</tr><tr class="odd"><td><code><a href="reference/plot_moneca_ggraph.html">plot_moneca_ggraph()</a></code></td>
<td>Network visualization</td>
</tr></tbody></table></div>
<div class="section level2">
<h2 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a></h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode bibtex"><code class="sourceCode bibtex"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">@software{moneca2025,</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">  author = {Montaletti, Giampaolo},</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">  title = {moneca: Mobility Network Clustering Analysis},</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">  version = {1.0.0},</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co">  year = {2025},</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">  url = {https://github.com/gmontaletti/moneca}</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co">}</span></span></code></pre></div>
<pre><code>
---

## Implementation Schedule

### Phase 1: API Consolidation
- [ ] Audit all exported functions
- [ ] Move internal functions
- [ ] Add deprecation warnings
- [ ] Update NAMESPACE
- [ ] Test backward compatibility

### Phase 2: Performance Optimization
- [ ] Implement `find_segments_optimized()`
- [ ] Implement `weight_matrix_optimized()`
- [ ] Add data.table dependency
- [ ] Create benchmark suite
- [ ] Validate result equivalence
- [ ] Profile memory usage

### Phase 3: Test Restructuring
- [ ] Create new test directory structure
- [ ] Write helper functions
- [ ] Migrate and consolidate tests
- [ ] Remove deprecated test files
- [ ] Verify coverage targets

### Phase 4: Documentation
- [ ] Consolidate vignettes
- [ ] Update function documentation
- [ ] Revise README.md
- [ ] Update CLAUDE.md
- [ ] Build and check documentation

### Final Steps
- [ ] Version bump to 1.0.0
- [ ] Update DESCRIPTION
- [ ] Full R CMD check
- [ ] Update citation in README
- [ ] Create release notes

---

## Risk Mitigation

1. **Result Compatibility**
   - All optimization changes must produce bit-identical results to original
   - Comprehensive regression test suite before any changes
   - `all.equal()` checks in CI

2. **Breaking Changes**
   - Soft deprecation with 2-version grace period
   - Clear migration documentation
   - Keep working aliases for removed functions

3. **Performance Regression**
   - Benchmark on standardized test data
   - Automated performance tests in CI
   - Fallback to original implementation if issues

---

## Appendix: Files to Archive

Move to `../reference/moneca/` (per CLAUDE.md):
</code></pre>
<p>R/parallel_moneca.R R/parallel_diagnostics.R R/smart_parallel_switching.R R/temporal_clustering.R R/temporal_stability.R R/temporal_plotting.R R/auto_tuning_enhanced.R R/auto_tuning_helpers.R R/auto_tuning_visualization.R R/joint_tuning.R R/multi_objective_optimization.R R/cutoff_rr_analysis.R R/cutoff_rr_visualization.R R/cutoff_sensitivity_strength.R R/advanced_optimization.R R/test_dependency_updates.R vignettes/algorithm-comparison.Rmd vignettes/moneca-statistics.Rmd vignettes/auto-tuning-guide.Rmd vignettes/parameter-calibration.Rmd</p>
<pre><code>
Test files to archive:</code></pre>
<p>tests/testthat/test-parallel-<em>.R tests/testthat/test-temporal-</em>.R tests/testthat/test-auto-tuning*.R (merge first) tests/testthat/test-joint-tuning.R tests/testthat/test-enhanced-joint-tuning.R tests/testthat/test-bayesian-parallel-behavior.R tests/testthat/test-new-moneca.R ```</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Giampaolo Montaletti, Jonas Touboel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

