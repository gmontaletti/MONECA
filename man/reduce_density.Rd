% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/density_reduction.R
\name{reduce_density}
\alias{reduce_density}
\title{Reduce Density of Large Mobility Matrices}
\usage{
reduce_density(
  mx,
  method = c("svd", "nmf"),
  normalization = c("none", "pearson", "ppmi"),
  k = "auto",
  variance_target = 0.75,
  threshold = NULL,
  threshold_type = c("sd", "percentile"),
  verbose = FALSE,
  seed = NULL
)
}
\arguments{
\item{mx}{A mobility matrix with totals row/column in standard moneca format.
Must have at least 4 rows/columns (excluding totals).}

\item{method}{Character string specifying the dimensionality reduction method:
\itemize{
  \item \code{"svd"} (default): Singular Value Decomposition - fast and
    memory-efficient, produces continuous values
  \item \code{"nmf"}: Non-negative Matrix Factorization - preserves
    non-negativity, better interpretability for count data
}}

\item{normalization}{Character string specifying pre-processing normalization:
\itemize{
  \item \code{"none"} (default): No normalization, use raw counts
  \item \code{"pearson"}: Pearson residuals - standardizes for marginal effects
  \item \code{"ppmi"}: Positive Pointwise Mutual Information - emphasizes
    mobility above chance levels
}}

\item{k}{Number of components to retain. Either \code{"auto"} (default) for
automatic selection based on variance explained, or a positive integer.
Typical range for 60+ category matrices is 15-25.}

\item{variance_target}{Numeric value (0-1) specifying target cumulative
variance to explain when \code{k = "auto"}. Default is 0.75. Higher values
retain more detail but also more noise.}

\item{threshold}{Optional sparsification threshold. Can be:
\itemize{
  \item \code{NULL} (default): No thresholding
  \item \code{"auto"}: Automatic threshold (mean + 1 SD)
  \item Numeric: Values below this threshold are set to zero
}}

\item{threshold_type}{Character string specifying how numeric threshold is
interpreted:
\itemize{
  \item \code{"sd"} (default): Number of standard deviations above mean
  \item \code{"percentile"}: Percentile threshold (0-100)
}}

\item{verbose}{Logical indicating whether to print progress information.
Default is \code{FALSE}.}

\item{seed}{Optional integer for reproducibility. Particularly important
for NMF which uses random initialization.}
}
\value{
An object of class \code{"density_reduced"} (inherits from matrix)
  with the following attributes:
  \describe{
    \item{method}{The reduction method used ("svd" or "nmf")}
    \item{normalization}{The normalization method used}
    \item{k}{Number of components retained}
    \item{variance_explained}{Proportion of variance explained (SVD only)}
    \item{threshold_applied}{The threshold value applied (if any)}
    \item{original_dims}{Dimensions of the original core matrix}
  }
}
\description{
Preprocesses large mobility matrices to reduce noise through dimensionality
reduction techniques. This function is designed for matrices with 60+
categories where noise can obscure meaningful mobility patterns.
}
\details{
The function implements a pipeline for reducing noise in large mobility matrices:

\enumerate{
  \item \strong{Input Validation}: Checks matrix format and extracts core
    matrix (excluding totals row/column)
  \item \strong{Normalization}: Optionally transforms counts using PPMI or
    Pearson residuals
  \item \strong{Component Selection}: When \code{k = "auto"}, uses variance
    explained with elbow detection
  \item \strong{Dimensionality Reduction}: Applies SVD or NMF to extract
    dominant patterns
  \item \strong{Reconstruction}: Reconstructs matrix from reduced components
  \item \strong{Post-processing}: Clips negatives, scales to preserve total,
    rounds to integers
  \item \strong{Thresholding}: Optionally sets low values to zero
  \item \strong{Totals}: Recalculates row/column totals
}

For SVD, the reconstruction is \eqn{M \approx U_k \Sigma_k V_k^T} where k
components are retained. For NMF, the factorization is \eqn{M \approx W H}
with non-negative factors.
}
\section{Dependencies}{

\itemize{
  \item \code{irlba}: Optional, for fast truncated SVD. Falls back to base R
    \code{svd()} if not available.
  \item \code{RcppML}: Required only for \code{method = "nmf"}
}
}

\examples{
# Generate large synthetic data
large_data <- generate_mobility_data(n_classes = 60, n_total = 30000, seed = 123)

# Basic SVD reduction with auto k selection
reduced <- reduce_density(large_data, verbose = TRUE)
print(reduced)

# SVD with PPMI normalization
reduced_ppmi <- reduce_density(large_data,
                               normalization = "ppmi",
                               variance_target = 0.80,
                               verbose = TRUE)

# NMF reduction with fixed k
\dontrun{
reduced_nmf <- reduce_density(large_data,
                              method = "nmf",
                              k = 20,
                              seed = 42)
}

# With thresholding to increase sparsity
reduced_sparse <- reduce_density(large_data,
                                 threshold = 1,
                                 threshold_type = "sd")

# Continue with standard moneca pipeline
seg <- moneca(reduced, segment.levels = 3)

}
\seealso{
\code{\link{plot_scree}} for visualizing component selection,
\code{\link{weight.matrix}} for the next step in the pipeline,
\code{\link{moneca}} for the main analysis function
}
