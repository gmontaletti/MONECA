% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cutoff_sensitivity_strength.R
\name{find_optimal_cutoff}
\alias{find_optimal_cutoff}
\title{Find Optimal Cut-off Based on Strength Patterns}
\usage{
find_optimal_cutoff(
  mx,
  criterion = "elbow",
  cutoff_range = NULL,
  n_bootstrap = 30,
  verbose = TRUE
)
}
\arguments{
\item{mx}{Mobility matrix with marginals (last row and column contain totals)}

\item{criterion}{Optimization criterion to use. One of:
\describe{
  \item{\code{"elbow"}}{Finds the "elbow" point in the strength ratio curve
    using the point of maximum curvature. This identifies where adding more
    edges provides diminishing returns in network strength concentration.
    \strong{Best for:} Automatic, data-driven cutoff selection without
    prior assumptions. \strong{Good for:} Finding a natural break point in
    network density where strong ties are separated from weak ties.
    \strong{Trade-off:} May not optimize for specific network properties
    like modularity or stability.}
  \item{\code{"stability"}}{Evaluates clustering stability using bootstrap
    resampling of the mobility matrix. Finds the cutoff where segment
    assignments are most consistent across resampled data, measured by
    coefficient of variation in node strengths. \strong{Best for:} Ensuring
    robust, reproducible clustering results. \strong{Good for:} Applications
    where stability and reliability are more important than optimizing other
    metrics. \strong{Trade-off:} Computationally expensive (uses n_bootstrap
    samples, default 30) and may favor more connected networks.}
  \item{\code{"balance"}}{Balances edge retention with strength concentration
    by maximizing the product: \deqn{score = edge\_retention \times strength\_ratio}
    This creates a trade-off between preserving network structure (many edges)
    and focusing on strong ties (high strength ratio). \strong{Best for:}
    General-purpose clustering when you want neither too sparse nor too dense
    networks. \strong{Good for:} Preserving interpretable network structure
    while maintaining focus on meaningful connections. \strong{Trade-off:}
    May produce intermediate solutions that don't excel at any single metric.}
  \item{\code{"modularity"}}{Maximizes network modularity using fast greedy
    community detection. Modularity measures how well the network separates
    into distinct communities. Higher modularity indicates stronger within-group
    connections and weaker between-group connections. \strong{Best for:}
    Identifying well-defined, non-overlapping social groups or mobility classes.
    \strong{Good for:} Sociological research focused on community structure
    and social stratification. \strong{Trade-off:} May favor sparser networks
    and can produce resolution limit issues in large networks.}
  \item{\code{"information"}}{Minimizes information loss while reducing network
    complexity by maximizing: \deqn{efficiency = strength\_retention / edge\_retention}
    This criterion keeps the most important connections (high strength) while
    maximally simplifying the network (few edges). \strong{Best for:} Creating
    parsimonious network representations with maximum explanatory power.
    \strong{Good for:} Visualization and interpretation where network clarity
    is important. \strong{Trade-off:} May produce very sparse networks that
    lose nuanced structural information.}
}}

\item{cutoff_range}{Numeric vector of cut-off values to test. If NULL
(default), automatically determined from the relative risk distribution
(5th to 95th percentile range)}

\item{n_bootstrap}{Integer. Number of bootstrap samples for stability criterion.
Higher values provide more reliable stability estimates but increase
computation time. Default is 30, which provides reasonable balance between
accuracy and speed}

\item{verbose}{Logical. Whether to show progress messages and sensitivity
analysis details. Default is TRUE}
}
\value{
A list of class \code{"optimal_cutoff"} containing:
  \describe{
    \item{\code{optimal_cutoff}}{Numeric. The recommended cut-off value based
      on the specified criterion}
    \item{\code{criterion}}{Character. The criterion used for optimization}
    \item{\code{metrics}}{Data frame row. Network metrics at the optimal cut-off,
      including n_edges, mean_strength, strength_ratio, modularity, n_components,
      and clustering_coefficient}
    \item{\code{sensitivity_analysis}}{Data frame. Complete sensitivity analysis
      across all tested cut-off values, useful for plotting and further analysis}
    \item{\code{explanation}}{Character. Human-readable explanation of why this
      cut-off was selected, including key metric values}
  }
}
\description{
Identifies the optimal cut-off value using various criteria based on
strength metrics and network structure. The cut-off parameter determines
which edges are included in the MONECA network by thresholding relative
risk values. This function provides multiple strategies for selecting an
optimal cut-off that balances network sparsity, clustering quality, and
interpretability.
}
\details{
\subsection{Cut-off Selection in MONECA}{
  The cut-off parameter is central to MONECA clustering as it determines
  which relative risk values create edges in the mobility network. Higher
  cut-offs produce sparser networks focusing on the strongest mobility ties,
  while lower cut-offs include weaker connections and produce denser networks.

  Choosing an appropriate cut-off affects:
  \itemize{
    \item Network density and interpretability
    \item Number and size of detected clusters
    \item Stability of cluster assignments
    \item Balance between within-cluster and between-cluster mobility
  }
}

\subsection{Recommended Workflow}{
  \enumerate{
    \item Start with \code{criterion = "elbow"} for an automatic, data-driven
      baseline cut-off
    \item Run sensitivity analysis to visualize how different cut-offs affect
      network properties
    \item If stability is critical (e.g., for longitudinal comparisons),
      use \code{criterion = "stability"}
    \item If identifying distinct communities is the goal, use
      \code{criterion = "modularity"}
    \item Compare results from multiple criteria to assess robustness
    \item Visualize the resulting networks using \code{plot_cutoff_analysis()}
      or \code{plot_moneca_ggraph()}
  }
}

\subsection{Computational Considerations}{
  \itemize{
    \item \strong{Fast criteria}: "elbow", "balance", "modularity", "information"
      (seconds for typical datasets)
    \item \strong{Slow criteria}: "stability" (minutes for n_bootstrap=30,
      scales linearly with n_bootstrap and quadratically with matrix size)
    \item For large matrices (>50 classes), consider reducing n_bootstrap
      or using a coarser cutoff_range
    \item All criteria benefit from narrower cutoff_range if you have prior
      knowledge about appropriate values
  }
}
}
\examples{
# Generate synthetic mobility data
data <- generate_mobility_data(n_classes = 5, seed = 123)

# 1. Find optimal cut-off using different criteria
optimal_elbow <- find_optimal_cutoff(data, criterion = "elbow", verbose = FALSE)
optimal_balance <- find_optimal_cutoff(data, criterion = "balance", verbose = FALSE)
optimal_mod <- find_optimal_cutoff(data, criterion = "modularity", verbose = FALSE)

# Compare results
print(optimal_elbow)
print(optimal_balance)
print(optimal_mod)

# Extract just the cut-off values for comparison
cat("Elbow method suggests:", round(optimal_elbow$optimal_cutoff, 3), "\n")
cat("Balance method suggests:", round(optimal_balance$optimal_cutoff, 3), "\n")
cat("Modularity method suggests:", round(optimal_mod$optimal_cutoff, 3), "\n")

# 2. Visualize sensitivity curves to understand criterion choices
sensitivity <- optimal_elbow$sensitivity_analysis

if (require(ggplot2, quietly = TRUE)) {
  library(ggplot2)

  # Plot strength ratio (elbow criterion looks for inflection point here)
  p1 <- ggplot(sensitivity, aes(x = cutoff, y = strength_ratio)) +
    geom_line() +
    geom_vline(xintercept = optimal_elbow$optimal_cutoff,
               linetype = "dashed", color = "red") +
    labs(title = "Elbow Point in Strength Ratio",
         x = "Cut-off", y = "Strength Ratio") +
    theme_minimal()
  print(p1)

  # Plot modularity (modularity criterion maximizes this)
  p2 <- ggplot(sensitivity, aes(x = cutoff, y = modularity)) +
    geom_line() +
    geom_vline(xintercept = optimal_mod$optimal_cutoff,
               linetype = "dashed", color = "blue") +
    labs(title = "Modularity Across Cut-offs",
         x = "Cut-off", y = "Modularity") +
    theme_minimal()
  print(p2)
}

# 3. Practical workflow: Find optimal cut-off and run MONECA
optimal <- find_optimal_cutoff(data, criterion = "balance", verbose = FALSE)

# Use the optimal cut-off in MONECA clustering
seg <- moneca(data, cut.off = optimal$optimal_cutoff, segment.levels = 3)

# Visualize the resulting network
if (require(ggraph, quietly = TRUE)) {
  plot_moneca_ggraph(seg, level = 1, node_color = "segment")
}

# 4. Compare network properties across criteria
criteria <- c("elbow", "balance", "modularity", "information")
results <- lapply(criteria, function(crit) {
  opt <- find_optimal_cutoff(data, criterion = crit, verbose = FALSE)
  data.frame(
    criterion = crit,
    cutoff = opt$optimal_cutoff,
    n_edges = opt$metrics$n_edges,
    modularity = opt$metrics$modularity,
    n_components = opt$metrics$n_components
  )
})
comparison <- do.call(rbind, results)
print(comparison)

# 5. Stability analysis (more computationally intensive)
\donttest{
optimal_stable <- find_optimal_cutoff(data, criterion = "stability",
                                      n_bootstrap = 50, verbose = TRUE)
print(optimal_stable)
}

}
\seealso{
\code{\link{cutoff_sensitivity_analysis}} for detailed sensitivity analysis,
\code{\link{evaluate_cutoff_strength}} for evaluating a single cut-off value,
\code{\link{plot_cutoff_analysis}} for visualizing sensitivity curves,
\code{\link{moneca}} for running the main clustering algorithm with the optimal cut-off
}
